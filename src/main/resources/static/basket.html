<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <title>Parts Store</title>
</head>
<body>

<div class="container mt-5">
    <h1>Parts Store</h1>

    <form id="searchForm" onsubmit="event.preventDefault(); searchForParts();">
        <div class="form-row">
            <div class="form-group col-md-6">

                <input type="text" class="form-control" id="serialNumber" name="serialNumber">
            </div>
            <div class="form-group col-md-6 mt-4">

            </div>
        </div>
    </form>



    <div id="searchResults"></div>
    <p id="totalCost"></p>
    <button class="btn btn-info mt-3" onclick="showPreviousResults()">Previous page</button>
    <button class="btn btn-info mt-3" onclick="showNextResults()">Next page</button>
    <a href="/index.html" class="btn btn-primary mt-3">Back to main page</a>
</div>

<script>
    let currentPage = 0;

    async function searchForParts() {
        const serialNumber = document.getElementById('serialNumber').value;
        const url = `basket?serialNumber=${serialNumber}&page=${currentPage}`;
        const response = await fetch(url);
        const data = await response.json();
        displaySearchResults(data);
        displayTotalCost(data);
    }

    async function searchParts() {
        const url = `basket?page=${currentPage}`;
        const response = await fetch(url);
        const data = await response.json();
        displaySearchResults(data);
        displayTotalCost(data);
    }

    async function deletePart(serialNumber) {
        if (confirm("Delete the part?")) {
            const url = `api/parts/${serialNumber}`;
            const response = await fetch(url, { method: 'DELETE' });
            if (response.ok) {
                alert('Deleted');
                searchParts();
            } else {
                alert('Error');
            }
        }
    }

    async function sellPart(serialNumber) {
        const sellQuantity = prompt(`Enter quantity :`);
        if (sellQuantity !== null) {
            const url = `api/parts/sell?serialNumber=${serialNumber}&quantity=${sellQuantity}`;
            const response = await fetch(url, { method: 'PATCH' });
            if (response.ok) {
                searchParts();
            } else {
                alert('Error.');
            }
        }
    }

    function goToNewPart() {
        window.location.href = 'newpart.html';
    }

    function goToBasket() {
        window.location.href = 'basket.html';
    }

    async function displaySearchResults(data) {
        const searchResultsDiv = document.getElementById('searchResults');
        searchResultsDiv.innerHTML = '';

        if (data.length > 0 && data[0].carDto.length > 0) {
            const table = document.createElement('table');
            table.classList.add('table', 'mt-3');

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th scope="col">Marka</th>
                    <th scope="col">Model</th>
                    <th scope="col">Numer Seryjny</th>
                    <th scope="col">Cena</th>
                    <th scope="col">Ilość</th>
                    <th scope="col">Plik</th>
                    <th scope="col">Akcje</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            for (const carPart of data[0].carDto) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${carPart.mark}</td>
                    <td>${carPart.model}</td>
                    <td>${carPart.serialNumber}</td>
                    <td>${carPart.price}</td>
                    <td>${carPart.quantity}</td>
                    <td>${await getFileDisplay(carPart)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deletePart('${carPart.serialNumber}')">Delete</button>
                        <button class="btn btn-warning" onclick="sellPart('${carPart.serialNumber}')">Buy</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            searchResultsDiv.appendChild(table);
        } else {
            searchResultsDiv.innerHTML = 'No results found.';
        }
    }

    async function displayTotalCost(data) {
        const totalCostElement = document.getElementById('totalCost');
        if (data.length > 0 && data[0].carDto.length > 0) {
            const totalCost = data[0].carDto.reduce((acc, carPart) => acc + (carPart.price * carPart.quantity), 0);
            totalCostElement.innerText = `Total Cost: ${totalCost.toFixed(2)} PLN`;
        } else {
            totalCostElement.innerText = '';
        }
    }

    async function getFileDisplay(carPart) {
        if (carPart.photoDto) {
            const base64String = btoa(new Uint8Array(carPart.photoDto).reduce(function (data, byte) {
                return data + String.fromCharCode(byte);
            }, ''));

            try {
                const fileType = await getFileType(carPart.serialNumber);

                if (fileType === "image") {
                    const imgBlob = base64ToBlob(base64String, 'image/jpeg');
                    const imgUrl = URL.createObjectURL(imgBlob);
                    return `<img src="${imgUrl}" alt="Zdjęcie" style="max-width: 50px;">`;
                } else if (fileType === "pdf" || fileType === "txt") {
                    return `<a href="#" onclick="openFile('${base64String}', '${fileType}')">Open file</a>`;
                }
            } catch (error) {
                console.error("Error getting file type:", error);
            }
        }

        return "No file";
    }

    async function openFile(base64String, fileType) {
        const blob = base64ToBlob(base64String, fileType);
        const blobUrl = URL.createObjectURL(blob);

        const formData = new FormData();
        formData.append("file", blob);

        const response = await fetch("api/parts/tmp", {
            method: "POST",
            body: formData
        });

        if (response.ok) {
            window.open(blobUrl, "_blank");
        } else {
            console.error("Error saving temporary file on the server");
        }
    }

    async function getFileType(serialNumber) {
        const url = `api/parts/filetype/${serialNumber}`;
        const response = await fetch(url);
        const fileType = await response.text();
        return fileType.trim().toLowerCase();
    }

    function showPreviousResults() {
        if (currentPage > 0) {
            currentPage--;
            searchParts();
        }
    }

    function showNextResults() {
        currentPage++;
        searchParts();
    }

    window.onload = searchParts;
</script>
</body>
</html>
